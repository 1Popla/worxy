<div class="hidden lg:block w-64 bg-white shadow-lg">
  <nav class="h-full flex flex-col">
    <div class="px-4 py-6 flex-grow">
      <div class="mb-8">
        <%= link_to image_tag('worxy-logo-cropped.svg', alt: 'Logo', class: "w-[250px]"), posts_path %>
      </div>
      <hr class="mb-6 border-gray-300">

        <div class="flex flex-col items-start space-y-2 mb-6">
          <span class="text-sm font-medium text-gray-700"><%= t('select_language') %></span>
          <div class="flex items-center space-x-4">
            <%= link_to url_for(locale: :en), class: "hover:opacity-80" do %>
              <%= image_tag("https://flagicons.lipis.dev/flags/4x3/gb.svg", alt: "English", class: "w-6 h-6") %>
            <% end %>
            <%= link_to url_for(locale: :nb), class: "hover:opacity-80" do %>
              <%= image_tag("https://flagicons.lipis.dev/flags/4x3/no.svg", alt: "Norsk", class: "w-6 h-6") %>
            <% end %>
          </div>
        </div>

      <h2 class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-2">
        <%= t('sidebar.main_title') %>
      </h2>
      <ul class="space-y-2 mb-6">
        <li>
          <%= link_to dashboard_index_path, id: 'dashboard-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-tachometer-alt mr-2 text-gray-700"></i>
            <%= t('sidebar.dashboard') %>
          <% end %>
        </li>
        <li>
          <%= link_to new_post_path, id: 'new-post-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-plus mr-2 text-gray-700"></i>
            <%= t('sidebar.new_post') %>
          <% end %>
        </li>
        <li>
          <%= link_to posts_path, id: 'posts-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-list mr-2 text-gray-700"></i>
            <%= t('sidebar.posts') %>
          <% end %>
        </li>
        <li>
          <%= link_to user_posts_posts_path, id: 'user-posts-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-user mr-2 text-gray-700"></i>
            <%= t('sidebar.user_posts') %>
          <% end %>
        </li>
      </ul>

      <h2 class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-2">
        <%= t('sidebar.communication_title') %>
      </h2>
      <ul class="space-y-2 mb-6">
        <li>
          <%= link_to conversations_path, id: 'conversations-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-comments mr-2 text-gray-700"></i>
            <%= t('sidebar.messages') %>
          <% end %>
        </li>
        <li class="relative">
          <%= link_to notifications_path, id: 'notifications-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700 notification-bell' do %>
            <i class="fas fa-bell mr-2 text-gray-700"></i>
            <%= t('sidebar.my_notifications') %>
            <span id="notification-count" class="absolute top-0 right-0 mt-1 mr-2 h-5 w-5 text-xs text-black bg-worxyYellow rounded-full flex items-center justify-center hidden"></span>
          <% end %>
        </li>
      </ul>

      <h2 class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-2">
        <%= t('sidebar.orders_title') %>
      </h2>
      <ul class="space-y-2 mb-6">
        <li>
          <%= link_to bookings_path, id: 'bookings-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-briefcase mr-2 text-gray-700"></i>
            <%= t('sidebar.orders') %>
          <% end %>
        </li>
        <li>
          <%= link_to calendar_bookings_path, id: 'calendar-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-calendar-alt mr-2 text-gray-700"></i>
            <%= t('sidebar.view_calendar') %>
          <% end %>
        </li>
        <li>
          <%= link_to dashboard_map_path, id: 'map-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-map mr-2 text-gray-700"></i>
            <%= t('sidebar.job_map') %>
          <% end %>
        </li>
      </ul>

      <h2 class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-2">
        <%= t('sidebar.user_title') %>
      </h2>
      <ul class="space-y-2">
        <li>
          <%= link_to user_path(current_user), id: 'profile-link', data: { turbo: true }, class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700' do %>
            <i class="fas fa-user-circle mr-2 text-gray-700"></i>
            <%= t('sidebar.user_profile') %>
          <% end %>
        </li>
        <li>
          <button id="tutorial-button" class="flex items-center block p-2 rounded hover:bg-gray-200 text-gray-700">
            <i class="fas fa-book mr-2 text-gray-700"></i>
            <%= t('sidebar.tutorial') %>
          </button>
        </li>
        <li>
          <%= link_to destroy_user_session_path,
                      method: :delete,
                      data: { turbo: false, confirm: t('sidebar.confirm_logout') },
                      class: 'flex items-center block p-2 rounded hover:bg-gray-200 text-red-600' do %>
            <i class="fas fa-sign-out-alt mr-2 text-gray-700"></i>
            <%= t('sidebar.log_out') %>
          <% end %>
        </li>
      </ul>
    </div>

    <div class="border-t border-gray-300 bg-gray-100">
      <%= link_to user_path(current_user), class: "flex items-center p-4 hover:bg-gray-200 transition-colors" do %>
        <% if current_user.avatar.present? %>
          <%= image_tag(current_user.avatar, alt: "#{current_user.first_name} #{current_user.last_name}", class: "w-10 h-10 rounded-full mr-3") %>
        <% else %>
          <div class="w-10 h-10 bg-gray-300 rounded-full mr-3 flex items-center justify-center">
            <i class="fas fa-camera text-white text-lg"></i>
          </div>
        <% end %>

        <div>
          <p class="text-gray-800 font-semibold">
            <%= current_user.first_name %> <%= current_user.last_name %>
          </p>
          <p class="text-gray-500 text-sm">
            <%= t('sidebar.view_profile') %>
          </p>
        </div>
      <% end %>
    </div>
  </nav>
</div>

<div class="lg:hidden bg-white shadow-lg fixed bottom-0 left-0 right-0 z-50 min-w-[300px] border-t border-l border-r border-gray-300 rounded-t-2xl">
  <div class="flex justify-between items-center px-4 py-2 relative">
    <%= link_to posts_path, id: 'mobile-posts-link', data: { turbo: true }, class: 'flex flex-col items-center justify-center p-2 mx-2' do %>
      <i class="fas fa-list text-gray-700 text-2xl"></i>
    <% end %>
    <%= link_to dashboard_map_path, id: 'mobile-calendar-link', data: { turbo: true }, class: 'flex flex-col items-center justify-center p-2 mx-2 -ml-12' do %>
      <i class="fas fa-map text-gray-700 text-2xl"></i>
    <% end %>

    <button id="expand-menu-button" class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-worxyYellow text-black rounded-full w-16 h-16 flex items-center justify-center shadow-lg transition duration-300 ease-in-out">
      <i class="fas fa-plus text-2xl transition-transform duration-300 ease-in-out"></i>
    </button>

    <%= link_to user_path(current_user), id: 'mobile-profile-link', data: { turbo: true }, class: 'flex flex-col items-center justify-center p-2 mx-2 -mr-12' do %>
      <i class="fas fa-user-circle text-gray-700 text-2xl"></i>
    <% end %>

    <%= link_to dashboard_index_path, id: 'mobile-dashboard-link', data: { turbo: true }, class: 'flex flex-col items-center justify-center p-2 mx-2' do %>
      <i class="fas fa-tachometer-alt text-gray-700 text-2xl"></i>
    <% end %>
  </div>
</div>

<div id="expanded-menu" class="lg:hidden fixed inset-0 bg-white z-40 hidden opacity-0 transition-opacity duration-300 ease-in-out">
  <div class="flex flex-col justify-center items-center h-full px-2">
    <ul class="space-y-2 text-center w-full">
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to new_post_path, id: 'expanded-new-post-link', data: { turbo: true }, class: 'flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out' do %>
          <i class="fas fa-plus text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.new_post') %></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to user_posts_posts_path, id: 'expanded-user-posts-link', data: { turbo: true }, class: 'flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out' do %>
          <i class="fas fa-user text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.user_posts') %></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to conversations_path, id: 'expanded-conversations-link', data: { turbo: true }, class: 'flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out' do %>
          <i class="fas fa-comments text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.messages') %></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to notifications_path, id: 'expanded-notifications-link', data: { turbo: true }, class: 'flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out notification-bell' do %>
          <i class="fas fa-bell text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.my_notifications') %></span>
          <span id="notification-count-expanded" class="ml-2 h-4 w-4 text-xs text-black bg-worxyYellow rounded-full flex items-center justify-center hidden"></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to bookings_path, id: 'expanded-bookings-link', data: { turbo: true }, class: 'flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out' do %>
          <i class="fas fa-briefcase text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.orders') %></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to calendar_bookings_path, id: 'expanded-calendar-link', data: { turbo: true }, class: 'flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out' do %>
          <i class="fas fa-calendar-alt text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.view_calendar') %></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <%= link_to destroy_user_session_path,
                    method: :delete,
                    data: { turbo: false, confirm: t('sidebar.confirm_logout') },
                    class: 'flex items-center text-lg text-red-600 font-medium hover:bg-red-50 p-2 rounded-lg transition duration-200 ease-in-out' do %>
          <i class="fas fa-sign-out-alt text-red-600 text-base mr-2"></i>
          <span><%= t('sidebar.log_out') %></span>
        <% end %>
      </li>
      <li class="bg-gray-100 p-2 rounded-lg shadow-lg transition duration-200 ease-in-out">
        <button id="expanded-tutorial-button" class="flex items-center text-lg text-gray-700 font-medium hover:bg-blue-50 p-2 rounded-lg transition duration-200 ease-in-out">
          <i class="fas fa-book text-gray-700 text-base mr-2"></i>
          <span><%= t('sidebar.tutorial') %></span>
        </button>
      </li>
    </ul>
  </div>
</div>

<script>
  document.getElementById('expand-menu-button').addEventListener('click', function () {
    var menu = document.getElementById('expanded-menu');
    var button = document.getElementById('expand-menu-button');
    var icon = button.querySelector('i');

    if (menu.classList.contains('hidden')) {
      menu.classList.remove('hidden');
      setTimeout(function() {
        menu.classList.add('opacity-100');
      }, 10);

      button.classList.remove('bg-worxyYellow');
      button.classList.add('bg-red-500');
      icon.classList.add('rotate-45');
    } else {
      menu.classList.remove('opacity-100');
      menu.addEventListener('transitionend', function () {
        menu.classList.add('hidden');
      }, { once: true });

      button.classList.remove('bg-red-500');
      button.classList.add('bg-worxyYellow');
      icon.classList.remove('rotate-45');
    }
  });

  function updateNotificationBell() {
    fetch('/notifications/unread_count')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        const count = data.unread_count;
        const notificationCountElements = document.querySelectorAll('#notification-count, #notification-count-mobile, #notification-count-expanded');

        notificationCountElements.forEach(el => {
          el.textContent = count;
          if (count > 0) {
            el.classList.remove('hidden');
            el.classList.add('block');
            const bells = document.querySelectorAll('.notification-bell');
            bells.forEach(bell => {
              bell.classList.add('animate-bounce');
            });
          } else {
            el.classList.remove('block');
            el.classList.add('hidden');
            const bells = document.querySelectorAll('.notification-bell');
            bells.forEach(bell => {
              bell.classList.remove('animate-bounce');
            });
          }
        });
      })
      .catch(error => {
        console.error('Fetch error:', error);
      });
  }

  document.addEventListener('turbo:load', updateNotificationBell);
  document.addEventListener('turbo:frame-load', updateNotificationBell);
  document.addEventListener('turbo:before-render', updateNotificationBell);
</script>
