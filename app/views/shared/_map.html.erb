<div id="map" style="height: 500px;"></div>

<script>
  function initMap() {
    var mapOptions = {
      zoom: 12,
      center: { lat: 51.9194, lng: 19.1451 }
    };

    var map = new google.maps.Map(document.getElementById('map'), mapOptions);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          map.setCenter(pos);
        },
        function() {
          handleLocationError(true, map.getCenter());
        }
      );
    } else {
      handleLocationError(false, map.getCenter());
    }

    var markers = [];

    <% @posts.each do |post| %>
      (function() {
        var marker = new google.maps.Marker({
          position: { lat: <%= post.latitude %>, lng: <%= post.longitude %> },
          map: map,
          title: "<%= post.title %>"
        });

        var infowindow = new google.maps.InfoWindow({
          content: `<h3><%= post.title %></h3><p><%= post.description %></p>`
        });

        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });

        markers.push(marker);
      })();
    <% end %>

    <% @bookings.each do |booking| %>
      (function() {
        var bookingMarker = new google.maps.Marker({
          position: { lat: <%= booking.post.latitude %>, lng: <%= booking.post.longitude %> },
          map: map,
          title: "Booking for <%= booking.post.title %> (Start: <%= booking.start_date.strftime('%Y-%m-%d %H:%M') %>)"
        });

        var bookingInfowindow = new google.maps.InfoWindow({
          content: `<h3>Booking for <%= booking.post.title %></h3><p>Booked by: <%= booking.user.email %></p><p>Start: <%= booking.start_date.strftime('%Y-%m-%d %H:%M') %></p><p>End: <%= booking.end_date.strftime('%Y-%m-%d %H:%M') %></p>`
        });

        bookingMarker.addListener('click', function() {
          bookingInfowindow.open(map, bookingMarker);
        });

        markers.push(bookingMarker);
      })();
    <% end %>
  }

  function handleLocationError(browserHasGeolocation, pos) {
    var infoWindow = new google.maps.InfoWindow({
      position: pos,
      content: browserHasGeolocation ?
               'Error: The Geolocation service failed.' :
               'Error: Your browser doesn\'t support geolocation.'
    });
    infoWindow.open(map);
  }

  document.addEventListener('turbo:load', function() {
    initMap();
  });
</script>
