<div class="flex h-screen bg-gray-100 overflow-hidden">
  <%= render 'shared/dashboard/sidebar' %>

  <div class="flex-1 overflow-auto">
    <div class="container mx-auto px-4 py-8">
      <%= form_with model: @post, id: dom_id(@post), local: true do |f| %>
        <div class="grid grid-cols-1 gap-6 mb-6">
          <div>
            <%= f.label :title, "Tytuł", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :title, placeholder: 'Tytuł', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :images, "Zdjęcia", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.file_field :images, multiple: true, class: 'block w-full text-sm text-gray-700 border rounded cursor-pointer focus:outline-none focus:border-purple-500', id: 'images' %>
            <div id="selected-images" class="mt-4"></div>
          </div>
          <div>
            <%= f.label :description, "Opis", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_area :description, placeholder: 'Opis', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline', rows: 10 %>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-6 mb-6">
          <div>
            <%= f.label :price, "Cena", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.number_field :price, placeholder: 'Cena', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline', step: 0.01 %>
          </div>
          <div>
            <%= f.label :category_id, "Kategoria", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.collection_select :category_id, @categories, :id, :name, { prompt: "Wybierz kategorię." }, class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :availability, "Dostępność", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :availability, placeholder: 'Dostępność', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :contact_information, "Informacje kontaktowe", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :contact_information, placeholder: 'Informacje kontaktowe', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :street, "Ulica", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :street, id: 'street', placeholder: 'Ulica', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :city, "Miasto", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :city, id: 'city', placeholder: 'Miasto', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :state, "Województwo", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :state, id: 'state', placeholder: 'Województwo', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
          <div>
            <%= f.label :country, "Kraj", class: 'block text-gray-700 text-sm font-bold mb-2' %>
            <%= f.text_field :country, id: 'country', placeholder: 'Kraj', class: 'shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline' %>
          </div>
        </div>
        
        <div class="hidden">
          <%= f.text_field :latitude, id: 'latitude', class: 'hidden' %>
          <%= f.text_field :longitude, id: 'longitude', class: 'hidden' %>
        </div>
        
        <div class="mb-6">
          <div id="map" class="w-full h-64 border rounded-lg"></div>
        </div>
        
        <%= f.submit 'Zatwierdź', class: 'w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline' %>
      <% end %>
    </div>
  </div>
</div>

<script>
  function initMap() {
    var mapElement = document.getElementById('map');
    if (!mapElement) {
      console.error("Map element not found!");
      return;
    }

    var map = new google.maps.Map(mapElement, {
      center: {lat: -34.397, lng: 150.644},
      zoom: 15
    });

    var marker;
    var geocoder = new google.maps.Geocoder();
    var autocomplete = new google.maps.places.Autocomplete(document.getElementById('street'));

    autocomplete.addListener('place_changed', function() {
      var place = autocomplete.getPlace();
      if (!place.geometry) {
        return;
      }
      map.setCenter(place.geometry.location);
      map.setZoom(17);

      if (marker) {
        marker.setPosition(place.geometry.location);
      } else {
        marker = new google.maps.Marker({
          position: place.geometry.location,
          map: map
        });
      }

      fillAddressFields(place);
    });

    google.maps.event.addListener(map, 'click', function(event) {
      var lat = event.latLng.lat();
      var lng = event.latLng.lng();

      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;

      if (marker) {
        marker.setPosition(event.latLng);
      } else {
        marker = new google.maps.Marker({
          position: event.latLng,
          map: map
        });
      }

      geocoder.geocode({'location': event.latLng}, function(results, status) {
        if (status === 'OK') {
          if (results[0]) {
            fillAddressFields(results[0]);
          }
        }
      });
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          map.setCenter(pos);
        },
        function() {
          handleLocationError(true, map.getCenter());
        }
      );
    } else {
      handleLocationError(false, map.getCenter());
    }
  }

  function fillAddressFields(place) {
    var addressComponents = place.address_components;

    addressComponents.forEach(function(component) {
      var types = component.types;
      if (types.indexOf('street_number') !== -1) {
        document.getElementById('street').value = component.long_name;
      }
      if (types.indexOf('route') !== -1) {
        document.getElementById('street').value += ' ' + component.long_name;
      }
      if (types.indexOf('locality') !== -1) {
        document.getElementById('city').value = component.long_name;
      }
      if (types.indexOf('administrative_area_level_1') !== -1) {
        document.getElementById('state').value = component.long_name;
      }
      if (types.indexOf('country') !== -1) {
        document.getElementById('country').value = component.long_name;
      }
    });
  }

  function handleLocationError(browserHasGeolocation, pos) {
    var infoWindow = new google.maps.InfoWindow({
      position: pos,
      content: browserHasGeolocation ?
               'Error: The Geolocation service failed.' :
               'Error: Your browser doesn\'t support geolocation.'
    });
    infoWindow.open(map);
  }

  document.addEventListener('turbo:load', function() {
    if (document.getElementById('map')) {
      initMap();
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('map')) {
      initMap();
    }
  });

  document.getElementById('images').addEventListener('change', function(event) {
    const selectedImagesContainer = document.getElementById('selected-images');
    selectedImagesContainer.innerHTML = '';
    Array.from(event.target.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.classList.add('w-32', 'h-32', 'object-cover', 'mr-2', 'mb-2');
        selectedImagesContainer.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });
</script>
